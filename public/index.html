<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ticketing</title>
    <style>
        :root {
            --bg: #f6f7f9;
            --text: #111827;
            --muted: #6b7280;
            --card: #ffffff;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --primary: #111827;
            --chip: #eef2ff;
            --border: #e5e7eb;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background: var(--bg);
            color: var(--text);
        }

        header {
            background: var(--primary);
            color: #fff;
            padding: 16px 20px;
        }

        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 0 16px;
        }

        .card {
            background: var(--card);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        input, textarea, select, button {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font: inherit;
        }

        input, textarea, select {
            background: #fff;
        }

        button {
            cursor: pointer;
            border: none;
            background: var(--primary);
            color: white;
            padding: 10px 14px;
        }

            button.secondary {
                background: #e5e7eb;
                color: var(--text);
            }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: var(--chip);
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .muted {
            color: var(--muted);
            font-size: 12px;
        }

        h3 {
            margin: 0 0 10px;
        }
    </style>
    <!-- React UMD (kein Build nötig) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body>
    <header><strong>Ticketing</strong> – einfach & schnell</header>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        const e = React.createElement;

        function api(path, options) {
            return fetch(path, { headers: { 'Content-Type': 'application/json' }, ...options }).then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.status === 204 ? null : r.json();
            });
        }

        function useTickets() {
            const [tickets, setTickets] = React.useState([]);
            const [statusFilter, setStatusFilter] = React.useState('');
            const [q, setQ] = React.useState('');

            const load = React.useCallback(() => {
                const params = new URLSearchParams();
                if (statusFilter) params.set('status', statusFilter);
                if (q) params.set('q', q);
                api('/api/tickets' + (params.toString() ? ('?' + params.toString()) : ''))
                    .then(setTickets).catch(console.error);
            }, [statusFilter, q]);

            React.useEffect(load, [load]);
            return { tickets, setTickets, statusFilter, setStatusFilter, q, setQ, reload: load };
        }

        function NewTicket({ onCreated }) {
            const [title, setTitle] = React.useState('');
            const [description, setDescription] = React.useState('');
            const submit = (ev) => {
                ev.preventDefault();
                if (!title.trim()) return alert('Titel eingeben');
                api('/api/tickets', { method: 'POST', body: JSON.stringify({ title, description }) })
                    .then(t => { setTitle(''); setDescription(''); onCreated(t); })
                    .catch(err => alert(err.message));
            };
            return e('form', { className: 'card', onSubmit: submit },
                e('h3', null, 'Neues Ticket'),
                e('div', { className: 'row' },
                    e('input', { placeholder: 'Titel', value: title, onChange: e => setTitle(e.target.value), style: { flex: 1, minWidth: 220 } }),
                ),
                e('div', null, e('textarea', { placeholder: 'Beschreibung (optional)', value: description, onChange: e => setDescription(e.target.value), rows: 3, style: { width: '100%', marginTop: 8 } })),
                e('div', { style: { marginTop: 10 } }, e('button', { type: 'submit' }, 'Erstellen'))
            );
        }

        function TicketCard({ t, onChange, onDelete }) {
            const [assignee, setAssignee] = React.useState(t.assignee || '');
            const [status, setStatus] = React.useState(t.status);

            const save = () => {
                api('/api/tickets/' + t.id, { method: 'PATCH', body: JSON.stringify({ assignee, status }) })
                    .then(onChange).catch(err => alert(err.message));
            };

            return e('div', { className: 'card' },
                e('div', { className: 'row', style: { justifyContent: 'space-between' } },
                    e('strong', null, `#${t.id} ${t.title}`),
                    e('span', { className: 'badge' }, t.status)
                ),
                t.description ? e('p', null, t.description) : null,
                e('p', { className: 'muted' }, `Zugewiesen an: ${t.assignee || '—'} · aktualisiert: ${new Date(t.updatedAt).toLocaleString()}`),
                e('div', { className: 'row' },
                    e('select', { value: status, onChange: (ev) => setStatus(ev.target.value) },
                        ['open', 'in_progress', 'closed'].map(s => e('option', { key: s, value: s }, s))
                    ),
                    e('input', { placeholder: 'Assignee', value: assignee, onChange: (ev) => setAssignee(ev.target.value), style: { flex: 1, minWidth: 160 } }),
                ),
                e('div', { className: 'actions', style: { marginTop: 10 } },
                    e('button', { onClick: save }, 'Speichern'),
                    e('button', { className: 'secondary', onClick: () => onDelete(t.id) }, 'Löschen')
                )
            );
        }

        function App() {
            const { tickets, setTickets, statusFilter, setStatusFilter, q, setQ, reload } = useTickets();

            const onCreated = (t) => setTickets(prev => [t, ...prev]);
            const onChange = () => reload();
            const onDelete = (id) => {
                if (!confirm('Ticket löschen?')) return;
                api('/api/tickets/' + id, { method: 'DELETE' })
                    .then(() => setTickets(prev => prev.filter(x => x.id !== id)))
                    .catch(err => alert(err.message));
            };

            return e(React.Fragment, null,
                e(NewTicket, { onCreated }),
                e('div', { className: 'card' },
                    e('div', { className: 'row' },
                        e('select', { value: statusFilter, onChange: e => setStatusFilter(e.target.value) },
                            e('option', { value: '' }, 'Status: alle'),
                            ['open', 'in_progress', 'closed'].map(s => e('option', { key: s, value: s }, s))
                        ),
                        e('input', { placeholder: 'Suche…', value: q, onChange: e => setQ(e.target.value), style: { flex: 1, minWidth: 220 } }),
                        e('button', { onClick: reload }, 'Aktualisieren')
                    )
                ),
                tickets.map(t => e(TicketCard, { key: t.id, t, onChange, onDelete }))
            );
        }

        ReactDOM.createRoot(document.getElementById('app')).render(e(App));
    </script>
</body>
</html>
