<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ticketing</title>
    <style>
        :root {
            --bg: #f6f7f9;
            --text: #111827;
            --muted: #6b7280;
            --card: #ffffff;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --primary: #111827;
            --chip: #eef2ff;
            --border: #e5e7eb;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background: var(--bg);
            color: var(--text);
        }

        header {
            background: var(--primary);
            color: #fff;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 0 16px;
        }

        .card {
            background: var(--card);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        input, textarea, select, button {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font: inherit;
        }

        input, textarea, select {
            background: #fff;
        }

        button {
            cursor: pointer;
            border: none;
            background: var(--primary);
            color: white;
            padding: 10px 14px;
        }

            button.secondary {
                background: #e5e7eb;
                color: var(--text);
            }

            button[disabled] {
                opacity: 0.6;
                cursor: not-allowed;
            }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: var(--chip);
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .muted {
            color: var(--muted);
            font-size: 12px;
        }

        h3 {
            margin: 0 0 10px;
        }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body>
    <header>
        <span><strong>Ticketing</strong> – einfach & schnell</span>
        <span id="userBadge" class="muted"></span>
    </header>
    <div class="container"><div id="app"></div></div>

    <script>
        const e = React.createElement;

        // --- Auth-State (Token + User) ---
        function loadAuth() { try { return JSON.parse(localStorage.getItem('auth') || 'null'); } catch { return null; } }
        function saveAuth(a) { localStorage.setItem('auth', JSON.stringify(a)); }
        function clearAuth() { localStorage.removeItem('auth'); }

        function api(path, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
            const auth = loadAuth();
            if (auth?.token) headers['Authorization'] = 'Bearer ' + auth.token;
            return fetch(path, { ...options, headers }).then(async r => {
                if (!r.ok) { const txt = await r.text().catch(() => ''); throw new Error(`HTTP ${r.status} ${txt}`); }
                return r.status === 204 ? null : r.json();
            });
        }

        function Login({ onLogin }) {
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');
            const submit = async (ev) => {
                ev.preventDefault();
                try {
                    const res = await api('/api/login', { method: 'POST', body: JSON.stringify({ username, password }) });
                    saveAuth(res); onLogin(res);
                } catch (err) { alert('Login fehlgeschlagen'); }
            };
            return e('form', { className: 'card', onSubmit: submit },
                e('h3', null, 'Anmelden'),
                e('div', { className: 'row' },
                    e('input', { placeholder: 'Benutzername', value: username, onChange: e => setUsername(e.target.value), style: { flex: 1, minWidth: 150 } }),
                    e('input', { placeholder: 'Passwort', type: 'password', value: password, onChange: e => setPassword(e.target.value), style: { flex: 1, minWidth: 150 } }),
                    e('button', { type: 'submit' }, 'Login')
                ),
                e('p', { className: 'muted' }, 'Demo: admin/admin123 oder user/user123')
            );
        }

        function NewTicket({ onCreated }) {
            const [title, setTitle] = React.useState('');
            const [description, setDescription] = React.useState('');
            const submit = (ev) => {
                ev.preventDefault();
                if (!title.trim()) return alert('Titel eingeben');
                api('/api/tickets', { method: 'POST', body: JSON.stringify({ title, description }) })
                    .then(t => { setTitle(''); setDescription(''); onCreated(t); })
                    .catch(err => alert(err.message));
            };
            return e('form', { className: 'card', onSubmit: submit },
                e('h3', null, 'Neues Ticket'),
                e('div', { className: 'row' },
                    e('input', { placeholder: 'Titel', value: title, onChange: e => setTitle(e.target.value), style: { flex: 1, minWidth: 220 } }),
                ),
                e('div', null, e('textarea', { placeholder: 'Beschreibung (optional)', value: description, onChange: e => setDescription(e.target.value), rows: 3, style: { width: '100%', marginTop: 8 } })),
                e('div', { style: { marginTop: 10 } }, e('button', { type: 'submit' }, 'Erstellen'))
            );
        }

        function TicketCard({ t, canAdmin, canClose, onChange, onDelete }) {
            const [title, setTitle] = React.useState(t.title);
            const [description, setDescription] = React.useState(t.description || '');
            const [assignee, setAssignee] = React.useState(t.assignee || '');
            const [status, setStatus] = React.useState(t.status);

            const save = () => {
                const payload = { title, description };
                if (canAdmin) { payload.status = status; payload.assignee = assignee; }
                api('/api/tickets/' + t.id, { method: 'PATCH', body: JSON.stringify(payload) })
                    .then(onChange).catch(err => alert(err.message));
            };

            const closeTicket = () => {
                if (!canClose) return;
                api('/api/tickets/' + t.id, { method: 'PATCH', body: JSON.stringify({ status: 'closed' }) })
                    .then(onChange).catch(err => alert(err.message));
            };

            const del = () => {
                if (!canAdmin) return;
                if (!confirm('Ticket löschen?')) return;
                api('/api/tickets/' + t.id, { method: 'DELETE' })
                    .then(() => onDelete(t.id)).catch(err => alert(err.message));
            };

            return e('div', { className: 'card' },
                e('div', { className: 'row', style: { justifyContent: 'space-between' } },
                    e('strong', null, `#${t.id}`),
                    e('span', { className: 'badge' }, t.status)
                ),
                e('div', { className: 'row' },
                    e('input', { value: title, onChange: e => setTitle(e.target.value), style: { flex: 1, minWidth: 220 } })
                ),
                e('div', null, e('textarea', { value: description, onChange: e => setDescription(e.target.value), rows: 3, style: { width: '100%', marginTop: 8 } })),
                e('p', { className: 'muted' }, `Erstellt von: ${t.createdBy || '—'} · aktualisiert: ${new Date(t.updatedAt).toLocaleString()}`),
                e('div', { className: 'row' },
                    e('select', { value: status, onChange: (ev) => setStatus(ev.target.value), disabled: !canAdmin },
                        ['open', 'in_progress', 'closed'].map(s => e('option', { key: s, value: s }, s))
                    ),
                    e('input', { placeholder: 'Assignee', value: assignee, onChange: (ev) => setAssignee(ev.target.value), style: { flex: 1, minWidth: 160 }, disabled: !canAdmin }),
                ),
                e('div', { className: 'actions', style: { marginTop: 10 } },
                    e('button', { onClick: save }, 'Speichern'),
                    canAdmin ? e('button', { className: 'secondary', onClick: del }, 'Löschen')
                        : e('button', { className: 'secondary', onClick: closeTicket, disabled: t.status === 'closed' || !canClose }, 'Schließen')
                )
            );
        }

        function App() {
            const [auth, setAuth] = React.useState(loadAuth());
            const [tickets, setTickets] = React.useState([]);
            const [statusFilter, setStatusFilter] = React.useState('');
            const [q, setQ] = React.useState('');

            const canAdmin = auth?.user?.role === 'admin';

            const reload = React.useCallback(() => {
                if (!auth) return;
                const params = new URLSearchParams();
                if (statusFilter) params.set('status', statusFilter);
                if (q) params.set('q', q);
                api('/api/tickets' + (params.toString() ? ('?' + params.toString()) : ''))
                    .then(setTickets).catch(err => {
                        if (String(err).includes('401')) { setAuth(null); clearAuth(); }
                    });
            }, [auth, statusFilter, q]);

            React.useEffect(() => {
                const el = document.getElementById('userBadge');
                if (auth?.user) el.textContent = `Eingeloggt als ${auth.user.username} (${auth.user.role})`;
                else el.textContent = 'Nicht angemeldet';
            }, [auth]);

            React.useEffect(() => { if (auth) reload(); }, [auth, reload]);

            const logout = () => { clearAuth(); setAuth(null); setTickets([]); };

            if (!auth) return e(Login, { onLogin: (a) => { setAuth(a); } });

            const onCreated = (t) => setTickets(prev => [t, ...prev]);
            const onChange = () => reload();
            const onDelete = (id) => setTickets(prev => prev.filter(x => x.id !== id));

            return e(React.Fragment, null,
                e('div', { className: 'card', style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                    e('div', { className: 'row' },
                        e('select', { value: statusFilter, onChange: e => setStatusFilter(e.target.value) },
                            e('option', { value: '' }, 'Status: alle'),
                            ['open', 'in_progress', 'closed'].map(s => e('option', { key: s, value: s }, s))
                        ),
                        e('input', { placeholder: 'Suche…', value: q, onChange: e => setQ(e.target.value), style: { flex: 1, minWidth: 220 } }),
                        e('button', { onClick: reload }, 'Aktualisieren')
                    ),
                    e('button', { className: 'secondary', onClick: logout }, 'Logout')
                ),
                e(NewTicket, { onCreated }),
                tickets.map(t => e(TicketCard, {
                    key: t.id, t,
                    canAdmin,
                    // user darf schließen/ändern wenn er Ersteller ist
                    canClose: canAdmin || (auth?.user?.username && t.createdBy === auth.user.username),
                    onChange, onDelete
                }))
            );
        }

        ReactDOM.createRoot(document.getElementById('app')).render(e(App));
    </script>
</body>
</html>
